<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FloodGuard - Dashboard Tác chiến AI</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    
    <style>
        body { font-family: 'Segoe UI', sans-serif; background-color: #f4f6f9; height: 100vh; overflow: hidden; }
        .sidebar { background-color: #1a202c; color: white; height: 100vh; width: 250px; position: fixed; z-index: 1000; }
        .sidebar .nav-link { color: #a0aec0; padding: 15px 20px; border-left: 4px solid transparent; }
        .sidebar .nav-link:hover, .sidebar .nav-link.active { background-color: #2d3748; color: #fff; border-left-color: #3182ce; }
        .main-content { margin-left: 250px; padding: 20px; height: 100vh; overflow-y: auto; }

        /* Map Container Size */
        #map {
            height: 70vh; 
            width: 100%;
            border-radius: 12px; 
            border: 2px solid #cbd5e0;
            z-index: 1;
        }

        /* Custom Popup Style */
        .custom-popup .leaflet-popup-content-wrapper {
            border-radius: 8px;
            padding: 0;
            overflow: hidden;
        }
        .custom-popup .leaflet-popup-content {
            margin: 10px;
            font-size: 13px;
        }
    </style>
</head>
<body>
    <div class="sidebar d-flex flex-column pt-3">
        <h4 class="text-center text-primary mb-4 fw-bold"><i class="fas fa-shield-alt"></i> FloodGuard</h4>
        <nav class="nav flex-column">
            <a class="nav-link active" href="index"><i class="fas fa-map-marked-alt me-2"></i> Bản đồ AI & Tác chiến</a>
            <a class="nav-link" href="sensor"><i class="fas fa-broadcast-tower me-2"></i> Cảm biến & IoT</a>
            <a class="nav-link" href="sos"><i class="fas fa-users me-2"></i> Quản lý SOS (Mesh) <span class="badge bg-danger ms-1">5</span></a>
            <a class="nav-link" href="grab"><i class="fas fa-box-open me-2"></i> Nguồn lực</a>
            <a class="nav-link" href="report"><i class="fas fa-chart-pie me-2"></i> Báo cáo Hiệu quả</a>
        </nav>
    </div>

    <div class="main-content">
        <div class="row mb-3">
            <div class="col-md-3">
                <div class="card p-3 border-0 shadow-sm border-start border-primary border-4">
                    <small class="text-muted">Thời gian cảnh báo sớm (Lead Time)</small>
                    <h3 class="fw-bold text-dark">55 Phút</h3>
                    <small class="text-success"><i class="fas fa-arrow-up"></i> Tăng 25% (Mục tiêu: 60p)</small>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card p-3 border-0 shadow-sm border-start border-danger border-4">
                    <small class="text-muted">Tình trạng mạng viễn thông</small>
                    <h3 class="fw-bold text-danger">Mất kết nối</h3>
                    <small class="text-warning"><i class="fas fa-project-diagram"></i> Đang chạy Mesh Network</small>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card p-3 border-0 shadow-sm bg-primary text-white">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h5 class="mb-1"><i class="fas fa-robot"></i> AI Prediction Warning</h5>
                            <small>Hệ thống dự báo nước sẽ tràn vào Xóm 4 trong <strong>18 phút</strong> nữa.</small>
                        </div>
                        <button class="btn btn-light text-primary fw-bold" onclick="toggleAIZone()">Kích hoạt Loa Phường</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-md-9">
                <div class="card border-0 shadow-sm h-100">
                    <div class="card-header bg-white d-flex justify-content-between align-items-center">
                        <h6 class="fw-bold m-0"><i class="fas fa-globe-asia"></i> Bản đồ thời gian thực (Hương Khê - Hà Tĩnh)</h6>
                        <div class="btn-group btn-group-sm">
                            <button class="btn btn-outline-danger active" onclick="toggleLayer('danger')"><i class="fas fa-bullseye"></i> Vùng nguy hiểm</button>
                            <button class="btn btn-outline-success active" onclick="toggleLayer('route')"><i class="fas fa-route"></i> Lộ trình sơ tán</button>
                            <button class="btn btn-outline-secondary" onclick="toggleLayer('community')"><i class="fas fa-camera"></i> Ảnh cộng đồng</button>
                        </div>
                    </div>
                    <div class="card-body p-0">
                        <div id="map"></div>
                    </div>
                </div>
            </div>
            
            <div class="col-md-3">
                <div class="card border-0 shadow-sm h-100">
                    <div class="card-header bg-white fw-bold">Đề xuất tác chiến</div>
                    <div class="card-body">
                        <div class="alert alert-danger mb-2">
                            <strong><i class="fas fa-exclamation-triangle"></i> Cảnh báo lũ quét</strong>
                            <p class="small mb-0">Khe suối Cầu Treo nước dâng nhanh.</p>
                        </div>
                        <button class="btn btn-primary w-100 mb-2 text-start">
                            <i class="fas fa-broadcast-tower me-2"></i> Gửi Push Notification
                        </button>
                        <button class="btn btn-success w-100 mb-2 text-start">
                            <i class="fas fa-map-signs me-2"></i> Cập nhật lộ trình sơ tán
                        </button>
                        <hr>
                        <small class="text-muted fw-bold">Dữ liệu từ:</small>
                        <ul class="list-unstyled small text-muted">
                            <li><i class="fas fa-check text-success"></i> 24 Cảm biến IoT</li>
                            <li><i class="fas fa-check text-success"></i> 150 User Cộng đồng</li>
                            <li><i class="fas fa-check text-success"></i> AI Model v2.1</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    
    <script>
        // 1. Khởi tạo bản đồ tại Hương Khê, Hà Tĩnh
        var map = L.map('map').setView([18.188, 105.715], 14); // Tọa độ giả lập khu vực Hương Khê

        // 2. Thêm lớp nền bản đồ (OpenStreetMap)
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
            attribution: '© OpenStreetMap'
        }).addTo(map);

        // --- DATA LAYERS ---

        // A. Vùng Nguy hiểm (AI Prediction Zone) - Hình tròn đỏ
        var dangerZone = L.circle([18.188, 105.715], {
            color: 'red',
            fillColor: '#f03',
            fillOpacity: 0.3,
            radius: 800, // Bán kính 800m
            dashArray: '10, 10' // Nét đứt thể hiện vùng dự báo
        }).addTo(map).bindPopup("<b>Dự báo AI:</b><br>Nước dâng >1.5m trong 1h tới.");

        // B. Lộ trình sơ tán (Safe Route) - Đường màu xanh
        var safeRouteLatLongs = [
            [18.188, 105.715], // Điểm xuất phát (Vùng nguy hiểm)
            [18.192, 105.718],
            [18.195, 105.722],
            [18.200, 105.730]  // Điểm tập kết (Trường học/UBND)
        ];
        var safeRoute = L.polyline(safeRouteLatLongs, {
            color: '#48bb78', 
            weight: 5,
            opacity: 0.8,
            dashArray: '5, 10',
            className: 'animated-route' // Có thể thêm CSS animation nếu muốn
        }).addTo(map).bindPopup("Lộ trình sơ tán an toàn");

        // Điểm tập kết
        L.marker([18.200, 105.730]).addTo(map)
            .bindPopup("<b>Điểm tập kết an toàn</b><br>Trường THPT Hương Khê");

        // C. Marker SOS (Chú Ba)
        // Tạo icon SOS tuỳ chỉnh
        var sosIcon = L.divIcon({
            className: 'custom-div-icon',
            html: "<div style='background-color:white; border:2px solid red; border-radius:50%; width:30px; height:30px; display:flex; align-items:center; justify-content:center; box-shadow:0 0 10px red;'><i class='fas fa-exclamation text-danger'></i></div>",
            iconSize: [30, 30],
            iconAnchor: [15, 15]
        });

        var sosMarker = L.marker([18.188, 105.715], {icon: sosIcon}).addTo(map)
            .bindPopup("<b class='text-danger'>SOS: Chú Ba</b><br>Nước 1.5m, có người già.<br><i>Mesh Hops: 3</i>").openPopup();

        // D. Ảnh cộng đồng (Community Photos) - Ví dụ
        var photoIcon = L.divIcon({
            className: 'custom-div-icon',
            html: "<div style='color: #4a5568;'><i class='fas fa-camera fa-lg'></i></div>",
            iconSize: [20, 20]
        });
        
        var photoMarker = L.marker([18.185, 105.712], {icon: photoIcon}); // Chưa add vào map ngay, chờ toggle

        // --- INTERACTION FUNCTIONS ---
        function toggleLayer(type) {
            if (type === 'danger') {
                if(map.hasLayer(dangerZone)) map.removeLayer(dangerZone);
                else map.addLayer(dangerZone);
            }
            if (type === 'route') {
                if(map.hasLayer(safeRoute)) map.removeLayer(safeRoute);
                else map.addLayer(safeRoute);
            }
            if (type === 'community') {
                if(map.hasLayer(photoMarker)) map.removeLayer(photoMarker);
                else {
                    photoMarker.addTo(map).bindPopup("Ảnh báo ngập tại ngõ 2");
                }
            }
        }
    </script>
</body>
</html>