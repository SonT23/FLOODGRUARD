<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FloodGuard - C·∫£m bi·∫øn Si√™u c·ª•c b·ªô</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.socket.io/4.7.4/socket.io.min.js"></script>

    <style>
        body { font-family: 'Segoe UI', sans-serif; background-color: #f4f6f9; height: 100vh; overflow: hidden; }
        .sidebar { background-color: #1a202c; color: white; height: 100vh; width: 250px; position: fixed; }
        .sidebar .nav-link { color: #a0aec0; padding: 15px 20px; }
        .sidebar .nav-link:hover, .sidebar .nav-link.active { background-color: #2d3748; color: #fff; border-left: 4px solid #3182ce; }
        .main-content { margin-left: 250px; padding: 20px; height: 100vh; overflow-y: auto; }
        
        .sensor-card { transition: all 0.2s; border: none; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .sensor-card:hover { transform: translateY(-3px); box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        
        /* Prediction Bar Style */
        .bar-container { height: 100px; display: flex; align-items: flex-end; justify-content: center; gap: 10px; background: #f7fafc; border-radius: 8px; padding-bottom: 5px; }
        .bar-current { width: 20px; background: #3182ce; border-radius: 4px 4px 0 0; transition: height 0.5s ease; }
        .bar-predict { width: 20px; background: repeating-linear-gradient(45deg,#e53e3e,#e53e3e 5px,#feb2b2 5px,#feb2b2 10px); border-radius: 4px 4px 0 0; opacity: 0.8; }
    </style>
</head>
<body>
    <div class="sidebar d-flex flex-column pt-3">
        <h4 class="text-center text-primary mb-4 fw-bold"><i class="fas fa-shield-alt"></i> FloodGuard</h4>
        <nav class="nav flex-column">
            <a class="nav-link" href="/index"><i class="fas fa-map-marked-alt me-2"></i> B·∫£n ƒë·ªì AI & T√°c chi·∫øn</a>
            <a class="nav-link active" href="/sensor"><i class="fas fa-broadcast-tower me-2"></i> C·∫£m bi·∫øn & IoT</a>
            <a class="nav-link" href="/sos"><i class="fas fa-users me-2"></i> Qu·∫£n l√Ω SOS (Mesh) <span class="badge bg-danger ms-1">5</span></a>
            <a class="nav-link" href="/grab"><i class="fas fa-box-open me-2"></i> Ngu·ªìn l·ª±c</a>
            <a class="nav-link" href="/report"><i class="fas fa-chart-pie me-2"></i> B√°o c√°o Hi·ªáu qu·∫£</a>
        </nav>
    </div>

    <div class="main-content">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h4 class="fw-bold">M·∫°ng l∆∞·ªõi C·∫£m bi·∫øn Si√™u c·ª•c b·ªô (Hyper-local)</h4>
            <span class="badge bg-success p-2"><i class="fas fa-satellite-dish"></i> Gateway ho·∫°t ƒë·ªông: <span id="connection-status">ƒêang k·∫øt n·ªëi...</span></span>
        </div>

        <div class="row g-4">
            <div class="col-md-4">
                <div class="card sensor-card p-3 border-danger border-2" id="card-sensor-01">
                    <div class="d-flex justify-content-between mb-2">
                        <span class="fw-bold text-danger"><i class="fas fa-water"></i> Khe Su·ªëi C·∫ßu Treo</span>
                        <span class="badge bg-danger" id="badge-sensor-01">B√ÅO ƒê·ªòNG 3</span>
                    </div>
                    
                    <div class="row align-items-end">
                        <div class="col-6">
                            <div class="text-muted small">M·ª±c n∆∞·ªõc hi·ªán t·∫°i</div>
                            <h2 class="text-dark fw-bold mb-0"><span id="val-sensor-01">1.8</span>m</h2>
                        </div>
                        <div class="col-6 text-end">
                             <div class="text-danger small fw-bold">D·ª± b√°o (+1h)</div>
                             <h2 class="text-danger fw-bold mb-0">2.5m</h2>
                        </div>
                    </div>

                    <div class="bar-container mt-3 mb-2">
                        <div class="bar-current" id="bar-sensor-01" style="height: 60%;" title="Hi·ªán t·∫°i"></div>
                        <div class="bar-predict" style="height: 90%;" title="D·ª± b√°o: 2.5m"></div>
                    </div>
                    
                    <div class="d-flex justify-content-between text-muted small border-top pt-2">
                        <span><i class="fas fa-tachometer-alt"></i> D√≤ng ch·∫£y: <strong>m·∫°nh (IMU)</strong></span>
                        <span><i class="fas fa-battery-three-quarters text-success"></i> 85%</span>
                    </div>
                </div>
            </div>

            <div class="col-md-4">
                <div class="card sensor-card p-3">
                    <div class="d-flex justify-content-between mb-2">
                        <span class="fw-bold text-dark"><i class="fas fa-map-pin"></i> Ng√µ 3 - X√≥m ƒê·∫°o</span>
                        <span class="badge bg-success">B√¨nh th∆∞·ªùng</span>
                    </div>
                    
                    <div class="row align-items-end">
                        <div class="col-6">
                            <h2 class="text-dark fw-bold mb-0">0.4m</h2>
                        </div>
                        <div class="col-6 text-end">
                             <div class="text-muted small">D·ª± b√°o (+1h)</div>
                             <h4 class="text-secondary fw-bold mb-0">0.5m</h4>
                        </div>
                    </div>

                    <div class="bar-container mt-3 mb-2">
                        <div class="bar-current bg-success" style="height: 15%;"></div>
                        <div class="bar-predict bg-secondary" style="height: 20%;"></div>
                    </div>
                    
                    <div class="d-flex justify-content-between text-muted small border-top pt-2">
                        <span><i class="fas fa-tachometer-alt"></i> D√≤ng ch·∫£y: Tƒ©nh</span>
                        <span><i class="fas fa-sun text-warning"></i> Solar OK</span>
                    </div>
                </div>
            </div>

            <div class="col-md-4">
                <div class="card sensor-card p-3 bg-light border-warning border-1">
                    <div class="d-flex justify-content-between mb-2">
                        <span class="fw-bold text-dark"><i class="fas fa-map-pin"></i> V√πng tr≈©ng H·ªë Nai</span>
                        <span class="badge bg-warning text-dark"><i class="fas fa-project-diagram"></i> Mesh Mode</span>
                    </div>
                    <div class="alert alert-warning py-1 small mb-2">
                        M·∫•t Wifi/4G. D·ªØ li·ªáu truy·ªÅn qua ƒëi·ªán tho·∫°i ng∆∞·ªùi d√¢n.
                    </div>
                    <h3 class="text-dark fw-bold mt-2">1.2m</h3>
                    <div class="text-muted small">C·∫≠p nh·∫≠t: 5 ph√∫t tr∆∞·ªõc (qua Node: Anh T√πng)</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 1. Connect to the Socket.io server
        const socket = io(); 

        // 2. Listen for connection status
        socket.on('connect', () => {
            const statusEl = document.getElementById('connection-status');
            statusEl.innerText = "ƒê√£ k·∫øt n·ªëi Realtime";
            statusEl.className = "text-white";
            console.log("Connected to server with ID:", socket.id);
        });

        // 3. Listen for sensor data updates (Server sends every 5 seconds)
        socket.on('new_sensor_data', (data) => {
            console.log("Received sensor data:", data); // Debugging line

            // Update only if data is for Sensor 01 (as per demo)
            if(data.sensorId === "SENSOR_01") {
                // Update the text value
                const valElement = document.getElementById('val-sensor-01');
                if (valElement) {
                    valElement.innerText = data.waterLevel;
                }
                
                // Update the bar chart height (Max limit 100%)
                let heightPercent = (data.waterLevel / 200) * 100; 
                if(heightPercent > 100) heightPercent = 100;
                
                const barElement = document.getElementById('bar-sensor-01');
                if (barElement) {
                    barElement.style.height = heightPercent + "%";
                }

                // Change warning badge color based on water level
                const badge = document.getElementById('badge-sensor-01');
                if (badge) {
                    if (data.warningLevel === 'danger') {
                        badge.className = "badge bg-danger animate__animated animate__flash";
                        badge.innerText = "NGUY HI·ªÇM";
                    } else {
                        badge.className = "badge bg-success";
                        badge.innerText = "AN TO√ÄN";
                    }
                }
            }
        });

        // 4. Listen for SOS alerts
        socket.on('sos_alert', (data) => {
            console.log("SOS Alert:", data);
            // Show alert popup
            alert(`üÜò C·∫¢NH B√ÅO: ${data.message} t·∫°i v·ªã tr√≠ [${data.lat}, ${data.lng}]`);
        });
    </script>
</body>
</html>