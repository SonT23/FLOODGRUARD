<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>FloodGuard - Qu·∫£n l√Ω SOS</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.socket.io/4.7.4/socket.io.min.js"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background-color: #f4f6f9; height: 100vh; overflow: hidden; }
        .sidebar { background-color: #1a202c; color: white; height: 100vh; width: 250px; position: fixed; }
        .sidebar .nav-link { color: #a0aec0; padding: 15px 20px; }
        .sidebar .nav-link:hover, .sidebar .nav-link.active { background-color: #2d3748; color: #fff; border-left: 4px solid #3182ce; }
        .main-content { margin-left: 250px; padding: 0; height: 100vh; display: flex; }
        
        /* Layout Chat */
        .sos-list { width: 320px; border-right: 1px solid #ddd; overflow-y: auto; background: #fff; display: flex; flex-direction: column; }
        .chat-area { flex: 1; display: flex; flex-direction: column; background: #f0f2f5; }
        
        /* Danh s√°ch SOS Item */
        .sos-item { cursor: pointer; transition: all 0.2s; border-left: 4px solid transparent; }
        .sos-item:hover { background-color: #f8f9fa; }
        .sos-item.active { background-color: #e8f0fe; border-left: 4px solid #0d6efd; }
        .sos-item.new-alert { animation: flashRed 2s infinite; }

        /* Khung tin nh·∫Øn */
        .chat-messages { flex: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 10px; }
        .message { max-width: 70%; padding: 10px 15px; border-radius: 15px; font-size: 0.95rem; position: relative; }
        
        .msg-in { background: #fff; align-self: flex-start; border-bottom-left-radius: 2px; box-shadow: 0 1px 2px rgba(0,0,0,0.1); }
        .msg-out { background: #0084ff; color: white; align-self: flex-end; border-bottom-right-radius: 2px; box-shadow: 0 1px 2px rgba(0,0,0,0.1); }
        
        .sender-name { font-size: 0.75rem; font-weight: bold; margin-bottom: 2px; display: block; color: #666; }
        .msg-out .sender-name { color: #e0e0e0; text-align: right; }

        @keyframes flashRed { 0% { background-color: rgba(220, 53, 69, 0.1); } 50% { background-color: rgba(220, 53, 69, 0.3); } 100% { background-color: rgba(220, 53, 69, 0.1); } }

        /* Thanh gi·∫£ l·∫≠p Demo */
        .demo-bar {
            background: #fff3cd; border-bottom: 1px solid #ffeeba; display: none; /* M·∫∑c ƒë·ªãnh ·∫©n */
            overflow-x: auto; white-space: nowrap;
        }
        .demo-bar::-webkit-scrollbar { height: 4px; }
        .demo-bar::-webkit-scrollbar-thumb { background: #ccc; border-radius: 4px; }
    </style>
</head>
<body>
    <div class="sidebar d-flex flex-column pt-3">
        <h4 class="text-center text-primary mb-4 fw-bold"><i class="fas fa-shield-alt"></i> FloodGuard</h4>
        <nav class="nav flex-column">
            <a class="nav-link" href="/index"><i class="fas fa-map-marked-alt me-2"></i> B·∫£n ƒë·ªì AI & T√°c chi·∫øn</a>
            <a class="nav-link" href="/sensor"><i class="fas fa-broadcast-tower me-2"></i> C·∫£m bi·∫øn & IoT</a>
            <a class="nav-link active" href="/sos"><i class="fas fa-users me-2"></i> Qu·∫£n l√Ω SOS (Mesh) <span class="badge bg-danger ms-1">5</span></a>
            <a class="nav-link" href="/grab"><i class="fas fa-box-open me-2"></i> Ngu·ªìn l·ª±c</a>
            <a class="nav-link" href="/report"><i class="fas fa-chart-pie me-2"></i> B√°o c√°o Hi·ªáu qu·∫£</a>
        </nav>
    </div>

    <div class="main-content">
        <div class="sos-list">
            <div class="p-3 bg-danger text-white d-flex justify-content-between align-items-center">
                <span class="fw-bold"><i class="fas fa-bell"></i> T√≠n hi·ªáu SOS</span>
                <span class="badge bg-white text-danger" id="sos-count">0</span>
            </div>
            <div id="sos-feed">
                <div class="p-4 text-center text-muted fst-italic" id="empty-state">
                    ƒêang qu√©t t√≠n hi·ªáu Mesh...
                </div>
            </div>
        </div>

        <div class="chat-area">
            <div class="p-3 bg-white border-bottom shadow-sm d-flex justify-content-between align-items-center">
                <div>
                    <strong class="fs-5" id="chat-title"><i class="fas fa-comments"></i> Ch·ªçn n·∫°n nh√¢n ƒë·ªÉ h·ªó tr·ª£</strong>
                    <div class="text-muted small" id="chat-subtitle">Ch∆∞a k·∫øt n·ªëi</div>
                </div>
                <div>
                    <button class="btn btn-outline-primary btn-sm" onclick="sendQuickMap()"><i class="fas fa-map-marked-alt"></i> G·ª≠i Map S∆° t√°n</button>
                    <button class="btn btn-danger btn-sm ms-1"><i class="fas fa-check"></i> Ho√†n th√†nh</button>
                </div>
            </div>
            
            <div class="chat-messages" id="chat-box">
                <div class="text-center text-muted mt-5">
                    <i class="fas fa-satellite-dish fa-3x mb-3 text-secondary"></i>
                    <p>H·ªá th·ªëng Mesh Network ƒëang ho·∫°t ƒë·ªông.<br>Vui l√≤ng ch·ªçn m·ªôt t√≠n hi·ªáu SOS b√™n tr√°i ƒë·ªÉ b·∫Øt ƒë·∫ßu ƒëi·ªÅu ph·ªëi.</p>
                </div>
            </div>

            <div class="p-2 demo-bar d-flex align-items-center gap-2" id="demo-bar">
                <small class="fw-bold text-danger fst-italic"><i class="fas fa-robot"></i> Gi·∫£ l·∫≠p N·∫°n nh√¢n:</small>
                <button class="btn btn-sm btn-outline-dark bg-white" onclick="simReply('N∆∞·ªõc l√™n nhanh qu√°, ng·∫≠p ƒë·∫øn c·ªï r·ªìi!')">üåä N∆∞·ªõc l√™n nhanh</button>
                <button class="btn btn-sm btn-outline-dark bg-white" onclick="simReply('T√¥i ƒëang ·ªü tr√™n m√°i nh√†, tr·ªùi t·ªëi qu√°')">üè† Tr√™n m√°i nh√†</button>
                <button class="btn btn-sm btn-outline-dark bg-white" onclick="simReply('Nh√† c√≥ ng∆∞·ªùi gi√† y·∫øu v√† tr·∫ª em')">üë¥ C√≥ ng∆∞·ªùi gi√†</button>
                <button class="btn btn-sm btn-outline-dark bg-white" onclick="simReply('ƒê√£ th·∫•y cano t·ª´ xa, c·∫£m ∆°n c√°n b·ªô!')">‚úÖ Th·∫•y Cano</button>
                <button class="btn btn-sm btn-outline-dark bg-white" onclick="simReply('ƒêi·ªán tho·∫°i s·∫Øp h·∫øt pin...')">ü™´ H·∫øt pin</button>
            </div>

            <div class="p-3 bg-white border-top">
                <div class="input-group">
                    <input type="text" id="msg-input" class="form-control" placeholder="Nh·∫≠p tin nh·∫Øn h·ªó tr·ª£..." disabled>
                    <button class="btn btn-primary" id="btn-send" onclick="sendMessage()" disabled>
                        <i class="fas fa-paper-plane"></i> G·ª≠i
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const socket = io();
        let currentVictimId = null; 
        let currentVictimName = null;

        // 1. L·∫Øng nghe SOS t·ª´ Server
        socket.on('sos_alert', (data) => {
            document.getElementById('empty-state').style.display = 'none';
            const countBadge = document.getElementById('sos-count');
            countBadge.innerText = parseInt(countBadge.innerText) + 1;
            const feed = document.getElementById('sos-feed');
            const elementId = `sos-${data.id}`;
            const timeStr = new Date().toLocaleTimeString();

            const newAlert = `
                <div class="sos-item p-3 border-bottom new-alert" id="${elementId}" 
                     onclick="selectVictim('${data.id}', '${data.message.substring(0, 15)}...', '${data.lat}', '${data.lng}')">
                    <div class="d-flex justify-content-between text-danger fw-bold">
                        <span>${data.type}</span>
                        <small class="text-muted fw-normal">${timeStr}</small>
                    </div>
                    <div class="fw-bold text-dark mt-1">Ng∆∞·ªùi d√¢n (ID: ${data.id.toString().slice(-4)})</div>
                    <div class="text-secondary small text-truncate">"${data.message}"</div>
                    <small class="text-muted"><i class="fas fa-map-marker-alt"></i> [${data.lat.toFixed(3)}, ${data.lng.toFixed(3)}]</small>
                </div>
            `;
            feed.insertAdjacentHTML('afterbegin', newAlert);
        });

        // 2. H√†m x·ª≠ l√Ω khi Click v√†o 1 d√≤ng SOS
        function selectVictim(id, nameSnippet, lat, lng) {
            currentVictimId = id;
            currentVictimName = "Ng∆∞·ªùi d√¢n " + id.toString().slice(-4);

            document.querySelectorAll('.sos-item').forEach(el => el.classList.remove('active', 'new-alert'));
            document.getElementById(`sos-${id}`).classList.add('active');

            document.getElementById('chat-title').innerHTML = `<i class="fas fa-user-injured text-danger"></i> ƒêang h·ªó tr·ª£: ${currentVictimName}`;
            document.getElementById('chat-subtitle').innerText = `V·ªã tr√≠: [${lat}, ${lng}] - K·∫øt n·ªëi qua Mesh Node`;

            document.getElementById('msg-input').disabled = false;
            document.getElementById('btn-send').disabled = false;
            
            // HI·ªÜN THANH GI·∫¢ L·∫¨P DEMO
            document.getElementById('demo-bar').style.display = 'flex';

            const chatBox = document.getElementById('chat-box');
            chatBox.innerHTML = `
                <div class="text-center my-3">
                    <span class="badge bg-secondary">ƒê√£ k·∫øt n·ªëi k√™nh ri√™ng t∆∞</span>
                    <div class="text-muted small mt-1">M·ªçi tin nh·∫Øn s·∫Ω ƒë∆∞·ª£c chuy·ªÉn ti·∫øp qua c√°c thi·∫øt b·ªã trung gian.</div>
                </div>
                <div class="message msg-in">
                    <span class="sender-name">${currentVictimName}</span>
                    C·ª©u t√¥i v·ªõi! "${nameSnippet}..."
                </div>
            `;
        }

        // 3. G·ª≠i tin nh·∫Øn (ADMIN)
        function sendMessage() {
            const input = document.getElementById('msg-input');
            const msg = input.value;
            if (msg.trim() !== "" && currentVictimId) {
                const chatBox = document.getElementById('chat-box');
                chatBox.innerHTML += `
                    <div class="message msg-out">
                        <span class="sender-name">Trung t√¢m ch·ªâ huy</span>
                        ${msg}
                    </div>
                `;
                chatBox.scrollTop = chatBox.scrollHeight;
                socket.emit('chat_message', { sender: 'Admin', targetId: currentVictimId, msg: msg });
                input.value = '';
            }
        }

        // 4. G·ª≠i tin nh·∫Øn gi·∫£ l·∫≠p (N·∫†N NH√ÇN TR·∫¢ L·ªúI) - M·ªöI
        function simReply(text) {
            if (!currentVictimId) return;
            // G·ª≠i s·ª± ki·ªán l√™n server v·ªõi sender KH√ÅC 'Admin'
            socket.emit('chat_message', { 
                sender: currentVictimName, // T√™n n·∫°n nh√¢n
                targetId: 'Admin', 
                msg: text 
            });
        }

        // 5. Nh·∫≠n tin nh·∫Øn t·ª´ Server
        socket.on('chat_message', (data) => {
            // N·∫øu tin nh·∫Øn kh√¥ng ph·∫£i do Admin g·ª≠i (th√¨ l√† do N·∫°n nh√¢n g·ª≠i)
            if (data.sender !== 'Admin') {
                const chatBox = document.getElementById('chat-box');
                chatBox.innerHTML += `
                    <div class="message msg-in">
                        <span class="sender-name">${data.sender}</span>
                        ${data.msg}
                    </div>
                `;
                chatBox.scrollTop = chatBox.scrollHeight;
            }
        });

        function sendQuickMap() {
            if (!currentVictimId) return alert("Vui l√≤ng ch·ªçn n·∫°n nh√¢n tr∆∞·ªõc!");
            const input = document.getElementById('msg-input');
            input.value = "üìç ƒê√£ g·ª≠i L·ªô tr√¨nh s∆° t√°n an to√†n v·ªÅ m√°y b·∫°n. H√£y ƒëi theo ƒë∆∞·ªùng m√†u xanh!";
            sendMessage();
        }

        document.getElementById("msg-input").addEventListener("keypress", function(event) {
            if (event.key === "Enter") sendMessage();
        });
    </script>
</body>
</html>